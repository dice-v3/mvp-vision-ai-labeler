version: '3.8'

# =============================================================================
# Vision AI Labeler - Development Environment
# =============================================================================
#
# Prerequisites:
#   Platform infrastructure must be running first:
#     cd ../mvp-vision-ai-platform && docker-compose up -d
#
# Usage:
#   docker-compose up -d              # Start Labeler services
#   docker-compose --profile init up  # First time: init DB + start services
#   docker-compose down               # Stop services
#   docker-compose logs -f            # View logs
#
# =============================================================================

services:
  # ================================
  # Database Initialization (run once)
  # ================================
  labeler-db-init:
    image: postgres:16-alpine
    container_name: labeler-db-init
    environment:
      PGPASSWORD: devpass
    entrypoint: >
      /bin/sh -c "
      echo 'Waiting for PostgreSQL...';
      until pg_isready -h postgres -U admin -d vision_platform; do sleep 2; done;
      echo 'Creating labeler database if not exists...';
      psql -h postgres -U admin -d vision_platform -tc \"SELECT 1 FROM pg_database WHERE datname = 'labeler'\" | grep -q 1 || psql -h postgres -U admin -d vision_platform -c 'CREATE DATABASE labeler';
      echo 'Database ready!';
      "
    networks:
      - vision-network
    profiles:
      - init  # Run with: docker-compose --profile init up

  # ================================
  # Labeler Backend - FastAPI
  # ================================
  labeler-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vision-labeler-backend
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      # App
      ENVIRONMENT: development
      DEBUG: "true"
      LOG_LEVEL: INFO
      API_HOST: "0.0.0.0"
      API_PORT: "8001"
      CORS_ORIGINS: "http://localhost:3010,http://localhost:3000"
      FRONTEND_URL: http://localhost:3010
      # Platform Database (read-only)
      PLATFORM_DB_HOST: postgres
      PLATFORM_DB_PORT: "5432"
      PLATFORM_DB_NAME: vision_platform
      PLATFORM_DB_USER: admin
      PLATFORM_DB_PASSWORD: devpass
      # Labeler Database
      LABELER_DB_HOST: postgres
      LABELER_DB_PORT: "5432"
      LABELER_DB_NAME: labeler
      LABELER_DB_USER: admin
      LABELER_DB_PASSWORD: devpass
      # S3/MinIO (shared with Platform)
      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: minioadmin
      S3_SECRET_KEY: minioadmin
      S3_BUCKET_DATASETS: vision-platform-dev
      S3_BUCKET_ANNOTATIONS: vision-platform-dev
      S3_REGION: us-east-1
      S3_USE_SSL: "false"
      # Keycloak (shared with Platform)
      KEYCLOAK_SERVER_URL: http://keycloak:8080
      KEYCLOAK_REALM: vision-ai
      KEYCLOAK_CLIENT_ID: labeler-backend
      KEYCLOAK_CLIENT_SECRET: ""
      KEYCLOAK_VERIFY_SSL: "false"
      # Service JWT
      SERVICE_JWT_SECRET: dev-service-jwt-secret
      SERVICE_JWT_ALGORITHM: HS256
    networks:
      - vision-network
    profiles:
      - app

  # ================================
  # Labeler Frontend - Next.js
  # ================================
  labeler-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: vision-labeler-frontend
    restart: unless-stopped
    ports:
      - "3010:3000"
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:8001
      NEXT_PUBLIC_APP_NAME: Vision AI Labeler
      NEXTAUTH_URL: http://localhost:3010
      NEXTAUTH_SECRET: dev-labeler-secret
      KEYCLOAK_CLIENT_ID: labeler-frontend
      KEYCLOAK_CLIENT_SECRET: ""
      KEYCLOAK_ISSUER: http://localhost:8080/realms/vision-ai
    depends_on:
      - labeler-backend
    networks:
      - vision-network
    profiles:
      - app

# =============================================================================
# Networks - Use Platform's network
# =============================================================================
networks:
  vision-network:
    external: true
    name: vision-network
